---
title: "simple_bayes_modelling"
author: "Martine Lind Jensen"
date: "2024-04-12"
output: html_document
---
```{r}
pacman::p_load(cmdstanr, tidyverse, LaplacesDemon, brms)
```


This needs to be done! 
```{r}
#Create function to simulate data 

sim_simple_f <- function(bias, FirstRating, GroupRating) {
  
  #Check if this is actually what we are modelling??
  outcome <- inv_logit_scaled(bias + logit_scaled(FirstRating) + logit_scaled(GroupRating))
  
  return(outcome)
}

#Simulate some data 

bias <- 0
trials <- seq(10)
FirstRating <- seq(1,8, 1)
GroupRating <- seq(1,8, 1)

sim_data_simB <- expand.grid(bias = bias, trials = trials, FirstRating = FirstRating, GroupRating = GroupRating)

for (n in seq(nrow(sim_data_simB))) {
  sim_data_simB$belief[n] <- sim_simple_f(sim_data_simB$bias[n], sim_data_simB$Source1[n], sim_data_simB$Source2[n])
  sim_data_simB$choice[n] <- rnorm(1,1, sim_data_simB$belief[n]) # which one should we do here, because its not rbinom when it is not binary data, have to choose from a normal distribution, cannot figure it out in my head right now
  sim_data_simB$continuous[n] <- sim_data_simB$belief[n]*9 #I dont know what he is doing here
  sim_data_simB$discrete[n] <- round(sim_data_simB$belief[n]*9,0) # Neither here
}

```

```{r compiling model}
file <- file.path("simple_sc.stan")

model_simple <- cmdstan_model(file, cpp_options = list(stan_threads = TRUE),
                     stanc_options = list("O1"))
```

```{r fitting model on simulated data}
samples_simple_sc_sim <- model_simple$sample(
  data = sim_data_simB, 
  #fixed_param = TRUE,
  seed = 123,
  chains = 2,
  parallel_chains = 2,
  threads_per_chain = 2,
  iter_warmup = 1500,
  iter_sampling = 3000,
  refresh = 500
)

samples_simple_sc_sim$save_object("models/simple_sc_sim.rds")
```


```{r cleaning data}
#remove na's in data 

df <- read_csv("data/data.csv")

df <- na.omit(df)

data <- list(
  N = 2598, 
  SecondRating = df$SecondRating, 
  FirstRating = df$FirstRating, 
  GroupRating = df$GroupRating
)
```

```{r fitting model to real data}
samples_simple_sc <- model_simple$sample(
  data = data,
  #fixed_param = TRUE,
  seed = 123,
  chains = 2,
  parallel_chains = 2,
  threads_per_chain = 2,
  iter_warmup = 1500,
  iter_sampling = 3000,
  refresh = 500
)

samples_simple_sc$save_object("models/simple_sc.rds")
```

```{r}
samples_simple_sc <- readRDS("models/simple_sc.rds")

samples_simple_sc$cmdstan_diagnose() #function checking the chains and stuff

samples_simple_sc$summary() # summarize the model

```

```{r}
samples_simple_sc$loo()
```

```{r}
# Extract posterior samples and include sampling of the prior:
simple_draws_df <- as_draws_df(samples_simple_sc$draws())
```

Model checking and plotting
- chains 
- priors
```{r}

```

Weighted model
```{r}

```

Model comparison 

```{r}

```

